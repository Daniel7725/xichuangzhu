{% extends "layout.html" %}

{% block page_title %}{{ review.Title }} (评论：{{review.WorkTitle}}){% endblock %}
{% block page_id%}page-single-review{% endblock %}

{% block body %}

<script type="text/javascript">

// move the blink to the end of the input/textarea
function moveEnd(obj){
	obj.focus();
	var len = obj.value.length;

	if (document.selection) {
		var sel = obj.createTextRange();
		sel.moveStart('character',len);
		sel.collapse();
		sel.select();
	}
	else if (typeof obj.selectionStart == 'number' && typeof obj.selectionEnd == 'number') {
		obj.selectionStart = obj.selectionEnd = len;
	}
}

$(document).ready(function(){
	$('.comment-item').hover(
		function(){
			$(this).find('.btn-reply-somebody').show();
		},
		function(){
			$(this).find('.btn-reply-somebody').hide();
		}
	);

	$('.btn-reply-somebody').click(function(){
		var target_username = $(this).attr('data-username'),
			comment = $("#textarea-comment").val();
		$("#textarea-comment").val("@" + target_username + " " + comment);
		moveEnd($("#textarea-comment")[0]);
	});
});

</script>

<div class="row">
	<div class="span8">
		<a href="{{ url_for('people', user_abbr=review.UserAbbr) }}" class="user-avatar">
			<img src="{{ review.Avatar }}">
		</a>
		
		<h1 class="review-title">{{ review.Title }}</h1>

		<div class="review-extra-info">
			<a href="{{ url_for('people', user_abbr=review.UserAbbr) }}">{{ review.Name }}</a>
			<span style="color:#333;">评</span>
			<a href="{{ url_for('single_work', work_id=review.WorkID) }}">{{ review.WorkTitle }}〔{{ review.Author }}〕</a>
			·
			<span class="review-time">{{ review.Time }}</span>
			·
			<span>{{ review.ClickNum }} 次点击</span>
			{% if session.user_id == review.UserID %}
			<a class="btn btn-mini btn-edit-review" href="{{ url_for('edit_review', review_id=review.ReviewID) }}">编辑</a>
			{% endif %}
		</div>

		<div class="review-content">{{ review.Content|safe }}</div>
		
		{% if comments|length != 0 %}
		<h2>回复</h2>
		{% endif %}

		{% for comment in comments %}
		<div class="comment-item clearfix">
			<a class="comment-user-avatar" href="{{ url_for('people', user_abbr=comment.Abbr) }}">
				<img src="{{ comment.Avatar }}">
			</a>

			<div class="comment-wap">
				<div class="comment-extra-info">
					<a href="{{ url_for('people', user_abbr=comment.Abbr) }}">{{ comment.Name }}</a>
					<span class="comment-time">{{ comment.Time }}</span>
					<a class="btn-reply-somebody" data-username="{{ comment.Name }}">回应</a>
				</div>

				<div class="comment-body">{{ comment.Comment|safe }}</div>
			</div>
		</div>
		{% endfor %}

		{% if session.user_id %}
		<form id="add-review-comment" method="post" action="{{ url_for('add_comment_to_review', review_id=review.ReviewID) }}">
			<textarea name="comment" class="input-xxlarge" rows="4" id="textarea-comment" placeholder="添加回复"></textarea>
			<input type="submit" class="btn btn-small" value="回复" />
		</form>
		{% endif %}
	</div>

	<div class="span4"></div>
</div>

{% endblock %}