{% extends "layout.html" %}

{% block page_title %}{{ work.Title }}{% endblock %}
{% block page_id%}page-single-work{% endblock %}

{% block body %}

<script type="text/javascript">

$(document).ready(function(){
	$('.work-content sup').tooltip();

	$('.work-content sup').each(function(index){
		$(this).text('〔' + (index + 1) + '〕');
	})
});

</script>

<div class="row">
	<div class="span8">
		<div class="work-title">{{ work.Title }}</div>

		<div class="work-author">
			〔<a href="{{ url_for('single_dynasty', dynasty_abbr = work.DynastyAbbr) }}">{{ work.Dynasty }}</a>〕<a href="{{ url_for('single_author', author_abbr=work.AuthorAbbr) }}">{{ work.Author }}</a>
		</div>
		
		{% if work.Type == 'ci' %}

		<!-- 32 is a experienced value -->
		{% if work.Foreword|length > 32 %}
		<div class="work-foreword" style="text-indent:2em; padding:0 2em;">{{ work.Foreword }}</div>
		{% else %}
		<div class="work-foreword" style="text-align:center;">{{ work.Foreword }}</div>
		{% endif %}

		{% endif %}

		<div class="work-content work-type-{{ work.Type }}">{{ work.Content|safe }}</div>
		
		{% if session.user_id %}
		<div class="btn-group pull-right">
			{% if is_loved %}
			<a class="btn btn-small" title="取消收藏" href="{{ url_for('unlove_work', work_id=work.WorkID) }}">已收藏 <span class="icon-heart"></span></a>
			{% else %}
			<a class="btn btn-small" title="点击收藏" href="{{ url_for('love_work', work_id=work.WorkID) }}">收藏 <span class="icon-heart"></span></a>
			{% endif %}
			
			<a class="btn btn-small" href="{{ url_for('add_review', work_id=work.WorkID) }}">点评 <span class="icon-file"></span></a>

			{% if session.user_id == 45197381 %}
			<a class="btn btn-small" href="{{ url_for('edit_work', work_id=work.WorkID) }}">编辑 <span class="icon-edit"></span></a>
			<!-- <a class="btn btn-small" href="{{ url_for('admin_widgets', target_type='work', target_id=work.WorkID) }}">挂件 <span class="icon-th"></span></a> -->
			{% endif %}
		</div>
		{% endif %}

		{% if work.CollectionID != 0 %}
		<h2>作品集</h2>
		<div class="work-collection"><a href="{{ url_for('single_collection', collectionID=work.CollectionID) }}">{{ work.Collection }}</a></div>
		<div class="work-collection-introduction">{{ work.Introduction|truncate(60, True) }}</div>
		{% endif %}

		<h2>题解</h2>
		<div class="work-introduction">{{ work.WorkIntroduction }}</div>
		
		<h2>点评</h2>
		{% for review in reviews %}
		<div class="review-item">
			<a class="user-avatar" href="{{ url_for('people', user_abbr=review.UserAbbr) }}">
				<img src="{{ review.Avatar }}">
			</a>
			
			<div class="review-wap">
				<a class="review-title" href="{{ url_for('single_review', review_id=review.ReviewID) }}">{{ review.Title }}</a>
				<div class="review-content">{{ review.Content|truncate(35, True) }}</div>
				<div class="review-extra-info">
					By
					<a href="{{ url_for('people', user_abbr=review.UserAbbr) }}">{{ review.Name }}</a>
					{{ review.Time }}
				</div>
			</div>
		</div>
		{% endfor %}
	</div>

	<div class="span4">
		{% for w in widgets %}

		{% if w.Title and w.Title != '' %}
		<h2>{{ w.Title }}</h2>
		{% endif %}
		
		<div>{{ w.Content|safe }}</div>
		
		{% endfor %}

		<h2>作者简介</h2>
		<div>{{ work.AuthorIntroduction|truncate(55, True) }}</div>

		<h2>其他作品</h2>

		{% for work in other_works %}
		<div class="other-work-item">
			<a class="other-work-title" href="{{ url_for('single_work', work_id = work.WorkID) }}">{{ work.Title|truncate(12, True, '') }}</a>
			<span class="other-work-content">{{ work.Content|truncate(8, True) }}</span>
		</div>
		{% endfor %}
		
		<a class="ad" title="{{ product.Product }}" href="{{ url_for('single_product', product_id=product.ProductID) }}"><img src="{{ product.ImageUrl }}"></a>

		<h2>谁收藏了它？</h2>

		{% for lover in lovers %}
		<div class="lover-item">
			<a class="lover-avatar" href="{{ url_for('people', user_abbr=lover.Abbr) }}"><img src="{{ lover.Avatar }}" /></a>
			<div class="lover-info">
				<div class="lover"><a href="{{ url_for('people', user_abbr=lover.Abbr) }}">{{ lover.Name }}</a></div>
				<div class="lover-signature">{{ lover.Signature }}</div>
				<div class="lover-reviews-num">点评 {{ lover.ReviewNum }}</div>
			</div>
		</div>
		{% endfor %}

	</div>
</div>

{% endblock %}